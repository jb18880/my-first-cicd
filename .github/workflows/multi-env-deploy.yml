name: ğŸŒ å¤šç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²

on:
  push:
    branches: 
      - main      # ç”Ÿäº§ç¯å¢ƒåˆ†æ”¯
      - develop   # å¼€å‘ç¯å¢ƒåˆ†æ”¯
  pull_request:
    branches: [ main ]

# è®¾ç½®æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # ğŸ§ª æµ‹è¯•ä»»åŠ¡ï¼ˆæ‰€æœ‰åˆ†æ”¯éƒ½è¿è¡Œï¼‰
  test:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ” åŸºç¡€æ–‡ä»¶æ£€æŸ¥
      run: |
        echo "ğŸ” æ£€æŸ¥å¿…è¦æ–‡ä»¶..."
        files=("index.html" "style.css" "script.js")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
    
    - name: ğŸ§ª é…ç½®æ–‡ä»¶æ£€æŸ¥
      run: |
        echo "ğŸ§ª æ£€æŸ¥ç¯å¢ƒé…ç½®..."
        if [ -f "config/dev.js" ] && [ -f "config/prod.js" ]; then
          echo "âœ… ç¯å¢ƒé…ç½®æ–‡ä»¶å®Œæ•´"
        else
          echo "âŒ ç¯å¢ƒé…ç½®æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
        echo "æ£€æŸ¥å¼€å‘ç¯å¢ƒé…ç½®..."
        node -c config/dev.js && echo "âœ… dev.js è¯­æ³•æ­£ç¡®"
        
        echo "æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒé…ç½®..."
        node -c config/prod.js && echo "âœ… prod.js è¯­æ³•æ­£ç¡®"
    
    - name: ğŸ“Š ç¯å¢ƒä¿¡æ¯
      run: |
        echo "ğŸ“Š æ„å»ºä¿¡æ¯:"
        echo "åˆ†æ”¯: ${GITHUB_REF#refs/heads/}"
        echo "æäº¤: ${GITHUB_SHA:0:8}"
        echo "è§¦å‘: ${{ github.event_name }}"
        echo "ä½œè€…: ${{ github.actor }}"

  # ğŸš§ å¼€å‘ç¯å¢ƒéƒ¨ç½²
  deploy-dev:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    environment:
      name: development
      url: https://dev-${{ github.event.repository.name }}.pages.dev
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½®
      run: |
        echo "ğŸš§ é…ç½®å¼€å‘ç¯å¢ƒ..."
        
        # ä¿®æ”¹HTMLæ ‡é¢˜ï¼Œæ·»åŠ å¼€å‘ç¯å¢ƒæ ‡è¯†
        sed -i 's/<title>\(.*\)<\/title>/<title>[DEV] \1<\/title>/g' index.html
        
        # ç¡®ä¿ä½¿ç”¨å¼€å‘ç¯å¢ƒé…ç½®
        echo "<!-- å¼€å‘ç¯å¢ƒæ„å»º: $(date) -->" >> index.html
        
        # æ˜¾ç¤ºå½“å‰é…ç½®
        echo "âœ… å¼€å‘ç¯å¢ƒé…ç½®å®Œæˆ:"
        echo "  - æ ‡é¢˜å·²æ·»åŠ [DEV]æ ‡è¯†"
        echo "  - ä½¿ç”¨å¼€å‘ç¯å¢ƒAPI"
        echo "  - å¯ç”¨è°ƒè¯•æ¨¡å¼"
    
    - name: ğŸš€ æ¨¡æ‹Ÿå¼€å‘ç¯å¢ƒéƒ¨ç½²
      run: |
        echo "ğŸš€ éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
        echo "ğŸ“ éƒ¨ç½²å†…å®¹:"
        ls -la
        echo ""
        echo "âœ… å¼€å‘ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
        echo "ğŸŒ å¼€å‘ç¯å¢ƒè®¿é—®åœ°å€: https://dev-myproject.example.com (æ¨¡æ‹Ÿ)"
        echo "ğŸ‘¥ å›¢é˜Ÿæˆå‘˜å¯ä»¥è®¿é—®æ­¤åœ°å€è¿›è¡Œæµ‹è¯•"
        echo "ğŸ”§ æ­¤ç¯å¢ƒåŒ…å«æœ€æ–°çš„å¼€å‘åŠŸèƒ½"

  # ğŸŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²  
  deploy-prod:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: âš™ï¸ ç”Ÿäº§ç¯å¢ƒé…ç½®
      run: |
        echo "ğŸ­ é…ç½®ç”Ÿäº§ç¯å¢ƒ..."
        
        # ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
        echo "æ‰§è¡Œç”Ÿäº§ç¯å¢ƒä¼˜åŒ–..."
        
        # æ·»åŠ ç”Ÿäº§ç¯å¢ƒæ ‡è¯†
        echo "<!-- ç”Ÿäº§ç¯å¢ƒæ„å»º: $(date) -->" >> index.html
        
        # ç§»é™¤è°ƒè¯•ä¿¡æ¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        sed -i '/console\.log/d' script.js 2>/dev/null || true
        
        echo "âœ… ç”Ÿäº§ç¯å¢ƒé…ç½®å®Œæˆ:"
        echo "  - ç§»é™¤è°ƒè¯•ä¿¡æ¯"
        echo "  - ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒAPI"
        echo "  - å¯ç”¨æ€§èƒ½ä¼˜åŒ–"
    
    - name: ğŸ”’ ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ£€æŸ¥
      run: |
        echo "ğŸ”’ æ‰§è¡Œå®‰å…¨æ£€æŸ¥..."
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯
        if grep -r "password\|secret\|key" . --exclude-dir=.git --exclude="*.yml" 2>/dev/null; then
          echo "âš ï¸ å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯ï¼Œè¯·æ£€æŸ¥"
        else
          echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡"
        fi
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶
        if grep -q "debugMode.*true" config/prod.js; then
          echo "âŒ ç”Ÿäº§ç¯å¢ƒä¸åº”è¯¥å¯ç”¨è°ƒè¯•æ¨¡å¼"
          exit 1
        else
          echo "âœ… ç”Ÿäº§ç¯å¢ƒé…ç½®æ£€æŸ¥é€šè¿‡"
        fi
    
    - name: ğŸ—ï¸ é…ç½®GitHub Pages
      uses: actions/configure-pages@v5
      
    - name: ğŸ“¦ æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./
        
    - name: ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: ğŸ‰ éƒ¨ç½²å®Œæˆé€šçŸ¥
      run: |
        echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸŒ ç”Ÿäº§åœ°å€: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ‘¥ ç”¨æˆ·ç°åœ¨å¯ä»¥è®¿é—®æœ€æ–°ç‰ˆæœ¬"
        echo "ğŸ“Š éƒ¨ç½²ç»Ÿè®¡:"
        echo "  - ç‰ˆæœ¬: $(grep -o 'v[0-9.]*' config/prod.js || echo 'æœªçŸ¥')"
        echo "  - æäº¤: ${GITHUB_SHA:0:8}"
        echo "  - éƒ¨ç½²æ—¶é—´: $(date)"