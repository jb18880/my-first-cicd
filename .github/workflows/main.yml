name: å¤šç¯å¢ƒCI/CDæµæ°´çº¿

on:
  push:
    branches: [ main, develop ]  # ä¸¤ä¸ªåˆ†æ”¯éƒ½è§¦å‘
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # æµ‹è¯•ä»»åŠ¡ï¼ˆæ‰€æœ‰åˆ†æ”¯éƒ½è¿è¡Œï¼‰
  test:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: ğŸ” æ£€æŸ¥å¿…è¦æ–‡ä»¶
      run: |
        echo "æ£€æŸ¥ç½‘ç«™æ–‡ä»¶æ˜¯å¦å®Œæ•´..."
        files=("index.html" "style.css" "script.js")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
    
    - name: ğŸ§ª HTMLè¯­æ³•æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥HTMLåŸºæœ¬è¯­æ³•..."
        if grep -q "<html>" index.html && grep -q "</html>" index.html; then
          echo "âœ… HTMLæ ‡ç­¾æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ HTMLæ ‡ç­¾ä¸å®Œæ•´"
          exit 1
        fi
        
        if grep -q "<title>" index.html; then
          echo "âœ… é¡µé¢æ ‡é¢˜å­˜åœ¨"
        else
          echo "âŒ ç¼ºå°‘é¡µé¢æ ‡é¢˜"
          exit 1
        fi
    
    - name: ğŸ”§ æ£€æŸ¥é…ç½®æ–‡ä»¶
      run: |
        echo "æ£€æŸ¥ç¯å¢ƒé…ç½®æ–‡ä»¶..."
        if [ -f "config/prod.js" ] && [ -f "config/dev.js" ]; then
          echo "âœ… ç¯å¢ƒé…ç½®æ–‡ä»¶å®Œæ•´"
        else
          echo "âŒ ç¼ºå°‘ç¯å¢ƒé…ç½®æ–‡ä»¶"
          exit 1
        fi
    
    - name: ğŸ“Š åˆ†æ”¯ä¿¡æ¯
      run: |
        echo "ğŸŒ¿ å½“å‰åˆ†æ”¯: ${GITHUB_REF#refs/heads/}"
        echo "ğŸ’» è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
        echo "ğŸ‘¤ æäº¤è€…: ${{ github.actor }}"

  # å¼€å‘ç¯å¢ƒéƒ¨ç½²
  deploy-dev:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    environment:
      name: development
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}-dev
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: ğŸ”§ ä½¿ç”¨å¼€å‘ç¯å¢ƒé…ç½®
      run: |
        echo "é…ç½®å¼€å‘ç¯å¢ƒ..."
        # ä½¿ç”¨å¼€å‘é…ç½®æ›¿æ¢ç”Ÿäº§é…ç½®
        cp config/dev.js config/current-config.js
        
        # ä¿®æ”¹HTMLå¼•ç”¨å¼€å‘é…ç½®
        sed -i 's|config/prod.js|config/current-config.js|g' index.html
        
        echo "âœ… å¼€å‘ç¯å¢ƒé…ç½®å®Œæˆ"
      
    - name: ğŸš§ æ·»åŠ å¼€å‘ç¯å¢ƒæ ‡è¯†
      run: |
        echo "æ·»åŠ å¼€å‘ç¯å¢ƒç‰¹æ®Šæ ‡è¯†..."
        # åœ¨titleåæ·»åŠ å¼€å‘æ ‡è¯†
        sed -i 's|<title>\(.*\)</title>|<title>[DEV] \1</title>|g' index.html
        echo "âœ… å¼€å‘ç¯å¢ƒæ ‡è¯†æ·»åŠ å®Œæˆ"
    
    - name: ğŸ“ æ˜¾ç¤ºå¼€å‘ç¯å¢ƒä¿¡æ¯
      run: |
        echo "ğŸ” å¼€å‘ç¯å¢ƒéƒ¨ç½²ä¿¡æ¯:"
        echo "- åˆ†æ”¯: develop"
        echo "- ç¯å¢ƒ: Development" 
        echo "- é…ç½®: ä½¿ç”¨å¼€å‘é…ç½®æ–‡ä»¶"
        echo "- ç‰¹æ€§: è°ƒè¯•æ¨¡å¼å¼€å¯ï¼Œæ˜¾ç¤ºç¯å¢ƒæ¨ªå¹…"
    
    - name: ğŸš€ æ¨¡æ‹Ÿéƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
      run: |
        echo "ğŸš§ æ­£åœ¨éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
        echo "âœ… å¼€å‘ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
        echo "ğŸŒ å¼€å‘ç¯å¢ƒåœ°å€: https://dev.yoursite.com (æ¨¡æ‹Ÿ)"

  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
  deploy-prod:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: âš™ï¸ ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒé…ç½®
      run: |
        echo "é…ç½®ç”Ÿäº§ç¯å¢ƒ..."
        # ç”Ÿäº§ç¯å¢ƒå·²ç»é»˜è®¤ä½¿ç”¨prod.jsï¼Œæ— éœ€ä¿®æ”¹
        echo "âœ… ç”Ÿäº§ç¯å¢ƒé…ç½®ç¡®è®¤"
      
    - name: ğŸ­ ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
      run: |
        echo "æ‰§è¡Œç”Ÿäº§ç¯å¢ƒä¼˜åŒ–..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ ä»£ç å‹ç¼©ã€å›¾ç‰‡ä¼˜åŒ–ç­‰
        echo "âœ… ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–å®Œæˆ"
    
    - name: ğŸ“ æ˜¾ç¤ºç”Ÿäº§ç¯å¢ƒä¿¡æ¯
      run: |
        echo "ğŸ” ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ä¿¡æ¯:"
        echo "- åˆ†æ”¯: main"
        echo "- ç¯å¢ƒ: Production"
        echo "- é…ç½®: ä½¿ç”¨ç”Ÿäº§é…ç½®æ–‡ä»¶"
        echo "- ç‰¹æ€§: æ— è°ƒè¯•ä¿¡æ¯ï¼Œä¼˜åŒ–æ€§èƒ½"
    
    - name: é…ç½®GitHub Pages
      uses: actions/configure-pages@v3
      
    - name: ä¸Šä¼ æ–‡ä»¶
      uses: actions/upload-pages-artifact@v2
      with:
        path: ./
        
    - name: ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
      id: deployment
      uses: actions/deploy-pages@v2
      
    - name: ğŸ‰ ç”Ÿäº§éƒ¨ç½²æˆåŠŸé€šçŸ¥
      run: |
        echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸŒ ç”Ÿäº§ç¯å¢ƒåœ°å€: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ¯ ç‰ˆæœ¬: v1.2"

  # ä»…PRæ—¶è¿è¡Œçš„æ£€æŸ¥
  pr-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
    - name: PRä¿¡æ¯æ£€æŸ¥
      run: |
        echo "ğŸ“‹ Pull Request ä¿¡æ¯:"
        echo "- æºåˆ†æ”¯: ${{ github.head_ref }}"  
        echo "- ç›®æ ‡åˆ†æ”¯: ${{ github.base_ref }}"
        echo "- æ ‡é¢˜: ${{ github.event.pull_request.title }}"
        echo "âœ… PRæ£€æŸ¥å®Œæˆï¼Œå¯ä»¥åˆå¹¶"
