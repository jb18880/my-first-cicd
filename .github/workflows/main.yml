name: å¤šç¯å¢ƒCI/CDæµæ°´çº¿

on:
  push:
    branches: [ main, develop ]  # âœ… ä¿®å¤ï¼šç›‘å¬ä¸¤ä¸ªåˆ†æ”¯
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # æµ‹è¯•ä»»åŠ¡ï¼ˆä¸¤ä¸ªåˆ†æ”¯éƒ½è¿è¡Œï¼‰
  test:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ” æ£€æŸ¥å¿…è¦æ–‡ä»¶
      run: |
        echo "æ£€æŸ¥ç½‘ç«™æ–‡ä»¶æ˜¯å¦å®Œæ•´..."
        files=("index.html" "style.css" "script.js")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
    
    - name: ğŸ§ª HTMLè¯­æ³•æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥HTMLåŸºæœ¬è¯­æ³•..."
        # æ£€æŸ¥HTMLæ ‡ç­¾æ˜¯å¦é…å¯¹
        if grep -q "<html>" index.html && grep -q "</html>" index.html; then
          echo "âœ… HTMLæ ‡ç­¾æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ HTMLæ ‡ç­¾ä¸å®Œæ•´"
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ ‡é¢˜
        if grep -q "<title>" index.html; then
          echo "âœ… é¡µé¢æ ‡é¢˜å­˜åœ¨"
        else
          echo "âŒ ç¼ºå°‘é¡µé¢æ ‡é¢˜"
          exit 1
        fi
    
    - name: ğŸ“Š åˆ†æ”¯ä¿¡æ¯æ˜¾ç¤º
      run: |
        echo "ğŸŒ¿ å½“å‰åˆ†æ”¯: ${GITHUB_REF#refs/heads/}"
        echo "ğŸ’» è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
        echo "ğŸ‘¤ æäº¤è€…: ${{ github.actor }}"
        echo "ğŸ“ˆ ä»£ç ç»Ÿè®¡ï¼š"
        echo "HTMLæ–‡ä»¶è¡Œæ•°: $(wc -l < index.html)"
        echo "CSSæ–‡ä»¶è¡Œæ•°: $(wc -l < style.css)" 
        echo "JSæ–‡ä»¶è¡Œæ•°: $(wc -l < script.js)"
    
    - name: ğŸ¯ è¿è¡Œè‡ªå®šä¹‰æµ‹è¯•
      run: |
        if [ -f "tests/test.js" ]; then
          echo "è¿è¡Œè‡ªå®šä¹‰æµ‹è¯•..."
          node tests/test.js
        else
          echo "æ²¡æœ‰æ‰¾åˆ°è‡ªå®šä¹‰æµ‹è¯•ï¼Œè·³è¿‡"
        fi

  # âœ… æ–°å¢ï¼šå¼€å‘ç¯å¢ƒéƒ¨ç½²ï¼ˆdevelopåˆ†æ”¯è§¦å‘ï¼‰
  deploy-dev:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ”§ é…ç½®å¼€å‘ç¯å¢ƒ
      run: |
        echo "ğŸš§ é…ç½®å¼€å‘ç¯å¢ƒ..."
        echo "- åˆ†æ”¯: develop"
        echo "- ç¯å¢ƒ: Development"
        echo "- ç‰¹æ€§: è°ƒè¯•æ¨¡å¼å¼€å¯"
        
        # å¦‚æœæœ‰config/dev.jsï¼Œä½¿ç”¨å¼€å‘é…ç½®
        if [ -f "config/dev.js" ]; then
          echo "âœ… å‘ç°å¼€å‘é…ç½®æ–‡ä»¶"
          # æ›¿æ¢é…ç½®å¼•ç”¨
          sed -i 's|config/prod.js|config/dev.js|g' index.html
        fi
        
        # æ·»åŠ å¼€å‘ç¯å¢ƒæ ‡è¯†
        sed -i 's|<title>\(.*\)</title>|<title>[DEV] \1</title>|g' index.html
    
    - name: ğŸš€ æ¨¡æ‹Ÿå¼€å‘ç¯å¢ƒéƒ¨ç½²
      run: |
        echo "ğŸš§ æ­£åœ¨éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
        echo "ğŸ“ å¼€å‘ç¯å¢ƒä¿¡æ¯:"
        echo "  - ç¯å¢ƒæ ‡è¯†: è“è‰²èƒŒæ™¯ + å¼€å‘æ¨ªå¹…"
        echo "  - è°ƒè¯•æ¨¡å¼: å¼€å¯"
        echo "  - ç‰ˆæœ¬: $(grep -o 'v[0-9.]*-dev' config/dev.js || echo 'devç‰ˆæœ¬')"
        echo "âœ… å¼€å‘ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
        echo "ğŸŒ å¼€å‘ç¯å¢ƒåœ°å€: https://dev-${GITHUB_REPOSITORY##*/}.example.com ï¼ˆæ¨¡æ‹Ÿï¼‰"
        echo "ğŸ‘¥ å¯ä¾›å›¢é˜Ÿå†…éƒ¨æµ‹è¯•ä½¿ç”¨"

  # âœ… ä¿®æ”¹ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ˆmainåˆ†æ”¯è§¦å‘ï¼‰
  deploy-prod:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: âš™ï¸ é…ç½®ç”Ÿäº§ç¯å¢ƒ
      run: |
        echo "ğŸ­ é…ç½®ç”Ÿäº§ç¯å¢ƒ..."
        echo "- åˆ†æ”¯: main"
        echo "- ç¯å¢ƒ: Production"
        echo "- ç‰¹æ€§: ä¼˜åŒ–æ€§èƒ½ï¼Œå…³é—­è°ƒè¯•"
        
        # ç¡®ä¿ä½¿ç”¨ç”Ÿäº§é…ç½®ï¼ˆé»˜è®¤å·²ç»æ˜¯prod.jsï¼‰
        if [ -f "config/prod.js" ]; then
          echo "âœ… ä½¿ç”¨ç”Ÿäº§é…ç½®æ–‡ä»¶"
        fi
    
    - name: ğŸ­ ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
      run: |
        echo "æ‰§è¡Œç”Ÿäº§ç¯å¢ƒä¼˜åŒ–..."
        echo "âœ… é…ç½®éªŒè¯å®Œæˆ"
        echo "âœ… æ€§èƒ½ä¼˜åŒ–å®Œæˆ"
        echo "âœ… å®‰å…¨æ£€æŸ¥å®Œæˆ"
      
    - name: é…ç½®GitHub Pages
      uses: actions/configure-pages@v5
      
    - name: ä¸Šä¼ æ–‡ä»¶
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./
        
    - name: ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: ğŸ‰ ç”Ÿäº§éƒ¨ç½²æˆåŠŸ
      run: |
        echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸŒ ç”Ÿäº§åœ°å€: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ‘¥ ç”¨æˆ·å¯ä»¥æ­£å¸¸è®¿é—®"
        echo "ğŸ“Š ç‰ˆæœ¬: $(grep -o 'v[0-9.]*' config/prod.js || echo 'æ­£å¼ç‰ˆ')"
